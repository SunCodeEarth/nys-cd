L.TopoJSON=L.GeoJSON.extend({addData:function(e){let t,o;if("Topology"===e.type){for(o in e.objects)e.objects.hasOwnProperty(o)&&(t=topojson.feature(e,e.objects[o]),L.GeoJSON.prototype.addData.call(this,t));return this}return L.GeoJSON.prototype.addData.call(this,e),this}}),L.topoJson=function(e,t){return new L.TopoJSON(e,t)},L.Control.coordProjection=L.Control.extend({options:{position:"bottomleft",separator:" | ",zoomLevel:!0,emptyString:" ",lngFirst:!1,numDigits:3,lngFormatter:void 0,latFormatter:void 0,prefix:"",crs:"EPSG4326"},onAdd:function(e){return this._container=L.DomUtil.create("div","leaflet-control-coord-projection"),L.DomEvent.disableClickPropagation(this._container),e.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(e){e.off("mousemove",this._onMouseMove)},_onMouseMove:function(e){let t=this._projectTo(this.options.crs,e.latlng,this.options.crsProjObject);this.options.crsProjObject||"EPSG4326"!==this.options.crs?(t=L.latLng(t.x,t.y),this.options.numDigits=3):this.options.numDigits=6;let o=this.options.lngFormatter?this.options.lngFormatter(t.lng):L.Util.formatNum(t.lng,this.options.numDigits),a=this.options.latFormatter?this.options.latFormatter(t.lat):L.Util.formatNum(t.lat,this.options.numDigits),i=this.options.lngFirst?o+this.options.separator+a:a+this.options.separator+o,r=(this.options.zoomLevel?"Zoom level: "+e.target.getZoom()+" at ":"")+this.options.prefix+" "+i;this._container.innerHTML=r},_projectTo:function(e,t){let o=[0,0];switch(e){case"EPSG3395":o=L.Projection.Mercator.project(t);break;case"EPSG3857":o=L.Projection.SphericalMercator.project(t);break;default:return t}return o},changeCrs:function(e){this.options.crs=e}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook((function(){this.options.positionControl&&(this.positionControl=new L.Control.coordProjection,this.addControl(this.positionControl))})),L.control.coordProjection=function(e){return new L.Control.coordProjection(e)},String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,(function(t,o){return void 0!==e[o]?e[o]:t}))};let checkStr=String.fromCharCode(10003,32),spaceStr=String.fromCharCode(160,160,160,160);var map=L.map("map",{fullscreenControl:!0}).setView([42.61,-75.33],7).fitBounds([[40.1,-79.86],[45.17,-71.69]]);let coordP=L.control.coordProjection({crs:"EPSG4326",lngFormatter:e=>Number(e).toFixed(3)+String.fromCharCode(176),latFormatter:e=>Number(e).toFixed(3)+String.fromCharCode(176)}).addTo(map),reAlignMapDIV=()=>{$("#map").height(window.innerHeight-$("#pageHeader").height())},geoJSON2DataArray=e=>{let t=Array(e.getLayers().length).fill(null),o=0;return e.eachLayer((e=>{t[o++]=e.feature.properties})),t},fitLayerFeature=(e,t,o,a)=>{let i=t[o];i&&i.eachLayer((t=>{t.feature.properties.id!=a||e.fitBounds(t.getBounds())}))},chartData=()=>{if($("#InfoDialog").dialog("isOpen")&&"dataChartLink"==infoDialogEvtSource)$("#InfoDialog").dialog("close");else{infoDialogEvtSource="dataChartLink",$("#InfoDialog").html("");let e="";$("#cd_map_list li a").each(((t,o)=>{o.innerText&&o.innerText.includes(checkStr)&&""==e&&(e=o.innerText.replace(checkStr,""))})),$("#InfoDialog").dialog("option","title",e).dialog("open");let t=geoJSON2DataArray(jsonMapLayers[e]);df=new dfd.DataFrame(t),df.setIndex({column:"id",inplace:!0}),df.rename({CCDist:"CCD (Circle Cumulative Distance)",CCDistPop:"Population weighted CCD"},{inplace:!0}),df.plot("InfoDialog").bar({layout:{title:"NYS Congressional District",legend:{title:{text:"Compactness <br>Measure   "},orientation:"h"}},config:{columns:["CCD (Circle Cumulative Distance)","Population weighted CCD"]}})}},showDataTable=()=>{if($("#InfoDialog").dialog("isOpen")&&"dataTableLink"==infoDialogEvtSource)return $("#InfoDialog").dialog("close"),null;{infoDialogEvtSource="dataTableLink",$("#InfoDialog").html("");let t="";$("#cd_map_list li a").each(((e,o)=>{o.innerText&&o.innerText.includes(checkStr)&&""==t&&(t=o.innerText.replace(checkStr,""))})),$("#InfoDialog").dialog("option","title",t).dialog("open");let o=geoJSON2DataArray(jsonMapLayers[t]);var e=new Tabulator("#InfoDialog",{data:o,rowHeight:32,index:"id",selectableRows:1,initialSort:[{column:"CCDist",dir:"asc"}],columns:[{title:"ID",field:"id"},{title:"CCD",field:"CCDist",sorter:"number",formatter:(e,t,o)=>{let a=e.getValue(),i="red";i=a<0?"red":a<.1?"orange":"green",o((function(){let t=[{x:[e.getValue()],y:[0],marker:{color:i},type:"bar",orientation:"h"}];$(e.getElement()).height;Plotly.newPlot(e.getElement(),t,layout={title:"",showlegend:!1,autosize:!1,width:100,height:26,margin:{l:1,r:1,b:1,t:1,pad:0},xaxis:{range:[-.51,.81]},yaxis:{range:[-.21,.21]}},{staticPlot:!0})}))}},{title:"CCD",field:"CCDist",sorter:"number",tooltip:"Circle Cumulative Distance",formatter:function(e,t,o){return e.getValue().toLocaleString("en-US",{maximumFractionDigits:3,minimumFractionDigits:3})}},{title:"PW-CCD",field:"CCDistPop",tooltip:"Population-weighted CCD",formatter:function(e,t,o){return e.getValue().toLocaleString("en-US",{maximumFractionDigits:3,minimumFractionDigits:3})}},{title:"Area (SQKM)",field:"gmArea",formatter:function(e,t,o){return(e.getValue()/1e6).toLocaleString("en-US",{maximumFractionDigits:1,minimumFractionDigits:1})}},{title:"Perimeter (KM)",field:"gmPerimeter",formatter:function(e,t,o){return(e.getValue()/1e3).toLocaleString("en-US",{maximumFractionDigits:1,minimumFractionDigits:1})}}]});return e.on("rowSelectionChanged",(function(e,o){1==e.length&&"table"==rowSelectSource&&fitLayerFeature(map,jsonMapLayers,t,e[0].id),rowSelectSource="table"})),e}};$(document).ready((()=>{reAlignMapDIV(),map.invalidateSize(!1),map.fitBounds([[40.1,-79.86],[45.17,-71.69]]),$("#InfoDialog").dialog({autoOpen:!1,width:550,show:{effect:"blind",duration:1e3},hide:{effect:"slideUp",duration:1e3},position:{my:"right top",at:"right top",of:"#map"}}),$("#aboutLink").on("click",(()=>{$("#InfoDialog").dialog("isOpen")&&"aboutLink"==infoDialogEvtSource?$("#InfoDialog").dialog("close"):(infoDialogEvtSource="aboutLink",$("#InfoDialog").html("<p>The delineation of electoral district boundaries is a fundamental component of democratic practice in the United States. However, gerrymandering—the manipulation of district boundaries to favor specific interest groups—undermines this process and often leads to contentious debates and legal battles. The website shows four sets of New York State’s 2022 congressional district maps for signs of gerrymandering. These maps were proposed by the Independent Redistricting Commission (IRC), the State Legislature, and the State Court, respectively. </p>       <p>I employed a quantitative metric that integrate factors such as population distribution, state boundaries, and spatial topology to assess district compactness and to identify gerrymandering (Sun S. 2021. Developing a Comprehensive and Coherent Shape Compactness Metric for Gerrymandering. Annals of the American Association of Geographers, 111(1), 175-195. doi:10.1080/24694452.2020.1760779). The results indicate that the Court-drawn congressional districts exhibit considerably lower levels of gerrymandering than the maps proposed by the IRC and the State Legislature. </p>").dialog("option","title","About").dialog("open"))})),$("#contactLink").on("click",(()=>{$("#InfoDialog").dialog("isOpen")&&"contactLink"==infoDialogEvtSource?$("#InfoDialog").dialog("close"):(infoDialogEvtSource="contactLink",$("#InfoDialog").html("<p><h5>Shipeng Sun</h5>                             <h7> shipeng.sun@hunter.cuny.edu </h7><br></p>                            <h7>                             Department of Geography & Environmental Science<br>                            Hunter College, CUNY <br>                            695 Park Ave <br>                             New York, NY 10065 <br>                            </h7> <br>                             <a href='http://www.geography.hunter.cuny.edu' target='_blank'>Geography@Hunter</a>").dialog("option","title","Contact").dialog("open"))})),$("#dataTableLink").on("click",(()=>{tableObj=showDataTable()})),$("#dataChartLink").on("click",chartData),$("#InfoDialog").dialog("option","height",.8*$("#map").height()),$(this).keydown((e=>{"KeyT"==e.code&&chartData()}))})),$(window).resize(reAlignMapDIV);var tableObj=null,chartObj=null,rowSelectSource="table",infoDialogEvtSource="";let baseMapLayerNames=["Esri.WorldGrayCanvas","CartoDB.Positron","OpenStreetMap.Mapnik","Stadia.AlidadeSmooth"],baseMapLayers=Array(baseMapLayerNames.length).fill(null);baseMapLayerNames.forEach(((e,t)=>{$("#baseMapDIV").append('<a href="#" class="w3-bar-item w3-button" id="bmap{0}" onclick="switchBaseMap({0})">{1}</a>'.format(t,e+spaceStr)),baseMapLayers[t]=L.tileLayer.provider(e)}));const switchBaseMap=e=>{let t=$("#bmap"+e).text();for(let o=0;o<baseMapLayerNames.length;++o)o!=e||t.includes(checkStr)?(baseMapLayers[o].removeFrom(map),$("#bmap"+o).text(baseMapLayerNames[o]+spaceStr)):(baseMapLayers[o].addTo(map),$("#bmap"+o).text(checkStr+baseMapLayerNames[o]))};switchBaseMap(0);let dataNames=["IRC Plan A","IRC Plan B","State Legislature","State Court"],jsonMapLayerZs=Array(dataNames.length).fill(null),layerPanes={};dataNames.forEach(((e,t)=>{map.createPane(dataNames[t]),jsonMapLayerZs[t]=449-t,map.getPane(dataNames[t]).style.zIndex=449-t}));let jsonMapLayers={},layerColors=d3.schemeSet1.slice(0,4),opacityInterpolator=d3.scaleSequential().domain([.5,-.3]);for(let e=0;e<dataNames.length;++e)jsonMapLayers[dataNames[e]]=L.topoJson(null,{pane:dataNames[e],style:function(t){return{color:layerColors[e],opacity:1,weight:1,fillColor:layerColors[e],fillOpacity:opacityInterpolator(t.properties.CCDistPop)}},onEachFeature:function(t,o){o.bindPopup("<p>Measture of District <strong>{3}</strong> (ID) in <strong> {2}</strong> Map:<br>                         Geometry CCPD: {0} <br>                         Populate Weighted CCPD: {1} <br><br>                         * CCPD is maximum Coverage Circle Path Distance-based metric. <br>                        * Compactness is opposite of gerrymandering.</p>".format(t.properties.CCDist.toLocaleString("en-US",{maximumFractionDigits:3,minimumFractionDigits:3}),t.properties.CCDistPop.toLocaleString("en-US",{maximumFractionDigits:3,minimumFractionDigits:3}),dataNames[e],t.properties.id)),o.on({mouseover:e=>{e.target.setStyle({fillColor:"#000",fillOpacity:o.options.fillOpacity+.2,weight:2}),tableObj&&(rowSelectSource="map",tableObj.selectRow(o.feature.properties.id),tableObj.scrollToRow(o.feature.properties.id,"top",!1))},mouseout:t=>{jsonMapLayers[dataNames[e]].resetStyle(t.target),tableObj&&tableObj.deselectRow(o.feature.properties.id)}})}}),fetch("./data/"+dataNames[e]+".topojson").then((e=>e.json())).then((t=>{jsonMapLayers[dataNames[e]].addData(t)}));jsonMapLayers[dataNames[0]].addTo(map),$("#cd_map_list").sortable({helper:"clone",start:(e,t)=>{},update:(e,t)=>{$("#cd_map_list li a").each(((e,t)=>{t.innerText&&t.innerText.replace(checkStr,"")&&jsonMapLayers&&jsonMapLayers[t.innerText.replace(checkStr,"")]&&(map.getPane(t.innerText.replace(checkStr,"")).style.zIndex=jsonMapLayerZs[e])}))}});const switchMapLayer=e=>{let t=$("#map"+e).text();t.includes(checkStr)?(jsonMapLayers[dataNames[e]].removeFrom(map),$("#map"+e).text(t.replace(checkStr,""))):(jsonMapLayers[dataNames[e]].addTo(map),$("#map"+e).text(checkStr+t))};